###########################################################
#   Description: Compile OpenWrt by GitHub Actions        #
#   Based on: https://github.com/P3TERX/Actions-OpenWrt   #
#   Author: Hyy2001X                                      #
###########################################################

name: autoupload-dl

### ä»¥ä¸‹å†…å®¹è¯·ä¿æŒä¸å˜
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿žæŽ¥åˆ° Actions'
        required: true
        default: 'false'
      ip_addr:
        description: 'å›ºä»¶ IP åœ°å€ [å¯é€‰]'
        default: ''
### END

  #push:
  #  branches: 
  #    - master

  #schedule:
  #  - cron: 0 8 * * 5

  #watch:
  #  types: [started]

### çŽ¯å¢ƒå˜é‡è®¾ç½®
env:
# è®¾å¤‡åç§°
  DEFAULT_TARGET: d-team_newifi-d2
# æºç ä»“åº“:åˆ†æ”¯
  DEFAULT_SOURCE: coolsnowwolf/lede:master
# ä¸Šä¼ å›ºä»¶åˆ° Github Releases
  UPLOAD_RELEASES: true
# ä¸Šä¼ å›ºä»¶åˆ° Github Artifacts
  UPLOAD_ARTIFACTS: false
# ä¸Šä¼  bin æ–‡ä»¶å¤¹åˆ° Github Artifacts
  UPLOAD_BIN_ARTIFACTS: false
# åˆ é™¤æ— ç”¨æ–‡ä»¶ä»¥é‡Šæ”¾æ›´å¤šç©ºé—´
  DELETE_USELESS_FILES: true
# åˆ é™¤æ—©æœŸçš„ workflow ä»»åŠ¡
  DELETE_OLD_WORKFLOW: true
### END

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization Define Info
      run: |
        DEFAULT_TARGET=${{ env.DEFAULT_TARGET }}
        DEFAULT_SOURCE=${{ env.DEFAULT_SOURCE }}
        DELETE_USELESS_FILES=${{ env.DELETE_USELESS_FILES }}
        echo "DEFAULT_TARGET=$DEFAULT_TARGET" >> $GITHUB_ENV
        echo "DELETE_USELESS_FILES=$DELETE_USELESS_FILES" >> $GITHUB_ENV
        [ ! -f "$GITHUB_WORKSPACE/Configs/$DEFAULT_TARGET" ] && {
            echo "[ERROR] No target_config file: [$DEFAULT_TARGET] detected!"
            exit 1
        }
        export REPO_URL="https://github.com/$(echo $DEFAULT_SOURCE | cut -d \: -f 1)"
        export REPO_BRANCH=$(echo $DEFAULT_SOURCE | cut -d \: -f 2)
        [ -z $REPO_BRANCH ] && REPO_BRANCH=master
        echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
        echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
        echo -e "TARGET_PROFILE: $DEFAULT_TARGET\nSOURCE: $REPO_URL:$REPO_BRANCH"

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get update
        sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync qemu-utils
        sudo timedatectl set-timezone "Asia/Shanghai"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        if [ "$DELETE_USELESS_FILES" == true ];then
            echo "Deleting useless files,please wait ..."
        fi
        echo "Compile_Date=$(date +%Y%m%d%H%M)" > $GITHUB_WORKSPACE/Openwrt.info
        echo "Display_Date=$(date +%Y/%m/%d)" >> $GITHUB_WORKSPACE/Openwrt.info
        echo "Defined_IP_Address=${{ github.event.inputs.IP }}" >> $GITHUB_WORKSPACE/Openwrt.info
        echo "Openwrt_Repo=$REPO_URL" >> $GITHUB_WORKSPACE/Openwrt.info
        echo "Artifacts_Date=$(date +%m%d%H%M)" >> $GITHUB_ENV
        touch Release_info

    - name: Clone Openwrt Source Code
      run: |
        git clone -b $REPO_BRANCH $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a > /dev/null 2>&1

    - name: SSH Connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.SSH == 'true' && github.event.inputs.SSH  != 'false') || contains(github.event.action, 'SSH')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Compile
      run: |
        export Compile_Result=false
        cd openwrt
        make defconfig
        make download -j$(nproc)
        [ $? == 0 ] && Compile_Result=true
        echo "Compile_Result=$Compile_Result" >> $GITHUB_ENV
        ls $GITHUB_WORKSPACE/openwrt
        pwd

    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: openwrt.ecoo.top
        username: openwrt
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: "/home/runner/work/openwrt-autoupdate/openwrt-autoupdate/openwrt/dl"
        server-dir: "openwrtdl"

